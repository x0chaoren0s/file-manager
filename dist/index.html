<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>文件管理器</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='2' y1='2' x2='22' y2='22' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0%25' stop-color='%234facfe'/%3E%3Cstop offset='100%25' stop-color='%2300f2fe'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23g)' d='M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6 10H6v-2h8v2zm4-4H6v-2h12v2z' opacity='.9'/%3E%3C/svg%3E">
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();function G(e){return!e||e==="/"?"/":e.endsWith("/")?e:e+"/"}const d={currentPathname:window.location.pathname,basePath:G(window.location.pathname),origin:window.location.origin,items:[],webdavCapable:!0,supportsPut:!0,supportsMove:!1,supportsDelete:!1};function x(e){return String(e).replace(/[&<>"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[t])}function B(e){if(e==null||isNaN(e))return"-";const t=["B","KB","MB","GB","TB"];let n=0,o=Number(e);for(;o>=1024&&n<t.length-1;)o/=1024,n++;return o.toFixed(o<10&&n>0?2:0)+" "+t[n]}function Q(e){if(!e)return"-";const t=new Date(e);if(String(t)==="Invalid Date")return"-";const n=o=>String(o).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}`}function F(e,t){return e.endsWith("/")||(e+="/"),e+t}function K(e){return e.split("/").map(t=>encodeURIComponent(t)).join("/").replace(/%2F/gi,"/")}function q(e,t){try{return new URL(e,t).pathname}catch{return e}}function Z(e){const t=String(e||"").toLowerCase();return!!([".txt",".log",".sh",".py",".md",".html",".htm",".css",".js",".json",".jsx",".ts",".tsx",".go",".c",".cpp",".h",".php",".sql",".yaml",".yml",".xml",".rs",".java",".kt",".swift",".rb",".lua",".pl"].some(o=>t.endsWith(o))||/\.(png|jpe?g|gif|svg|bmp|webp)$/.test(t)||/\.(mp4|webm|ogg|mov)$/.test(t))}function ee(e){const t=String(e||"").toLowerCase();return/\.(png|jpe?g|gif|svg|bmp|webp)$/.test(t)}function te(e){const t=String(e||"").toLowerCase();return/\.(mp4|webm|ogg|mov)$/.test(t)}function ne(e,t){const n=e.endsWith("/")?e:e+"/",o=t.endsWith("/")?t:t+"/";return n===o}function oe(e){const t=String(e||"").toLowerCase();return t.match(/\.(png|jpe?g|gif|svg|bmp|webp)$/)?"图片":t.match(/\.(mp4|webm|ogg|mov|avi|mkv|flv)$/)?"视频":t.match(/\.(mp3|wav|flac|aac|m4a|ogg)$/)?"音频":t.match(/\.(html|htm|css|js|json|jsx|ts|tsx|py|sh|go|c|cpp|h|php|sql|yaml|yml|xml)$/)?"代码":t.match(/\.(md|markdown|txt|log|pdf|doc|docx|xls|xlsx|ppt|pptx|rtf|epub)$/)?"文档":t.match(/\.(zip|rar|7z|tar|gz|bz2|xz)$/)?"压缩包":t.match(/\.(exe|msi|deb|rpm|dmg|apk)$/)?"程序":"文件"}const w={path:document.getElementById("current-path"),status:document.getElementById("status"),tbody:document.getElementById("file-tbody"),refreshBtn:document.getElementById("refresh-btn"),fileInput:document.getElementById("file-input"),dropzone:document.getElementById("upload-zone")};function g(e,t="info"){if(!e){w.status.textContent="";return}const n=t==="error"?"错误：":t==="success"?"完成：":"";w.status.textContent=n+e}function V(e){const t=d.basePath.split("/").filter(Boolean),n=[],o=document.createElement("a");o.href="/",o.textContent="/",o.onclick=r=>{r.preventDefault(),e("/")},n.push(o.outerHTML);let s="";for(let r=0;r<t.length;r++){s+="/"+t[r];const i=decodeURIComponent(t[r]),u=s+"/",l=document.createElement("span");l.className="muted",l.textContent="/";const a=document.createElement("a");a.href=u,a.textContent=x(i);const m=u;a.onclick=c=>{c.preventDefault(),e(m)},n.push(l.outerHTML+" "+a.outerHTML)}w.path.innerHTML=n.join(" ")}function se(e){if(!d.items.length){w.tbody.innerHTML='<tr><td colspan="4" class="muted">空目录</td></tr>';return}const t=d.items.map(n=>{const o=n.href,s=n.isDir?"目录":oe(n.name),r=n.isDir?`<span class="tag">${s}</span><a href="${o}" class="dir-link">${x(n.name)}/</a>`:`<span class="tag">${s}</span><a href="${o}" download>${x(n.name)}</a>`,i=n.isDir?"-":n.size!=null?B(n.size):n.sizeRaw||"-",u=n.mtime?Q(n.mtime):n.mtimeRaw||"-",l=[];n.isDir?l.push(`<button class="btn action-enter" data-href="${o}">打开</button>`):(Z(n.name)&&l.push(`<button class="btn action-view" data-href="${o}" data-name="${x(n.name)}">查看</button>`),l.push(`<a class="btn" href="${o}" download>下载</a>`)),d.supportsMove&&l.push(`<button class="btn action-rename" data-href="${o}">重命名</button>`),d.supportsDelete&&l.push(`<button class="btn danger action-delete" data-href="${o}">删除</button>`);const a=l.join(" ");return`<tr>
      <td>
        <div class="name">${r}</div>
        <div class="mobile-only">
          <div><span>${i}</span><span style="margin:0 6px;">•</span><span>${u}</span></div>
          <div class="mobile-actions">${a}</div>
        </div>
      </td>
      <td class="nowrap desktop-only">${i}</td>
      <td class="nowrap desktop-only">${u}</td>
      <td class="desktop-only"><div class="actions">${a}</div></td>
    </tr>`}).join("");w.tbody.innerHTML=t,w.tbody.querySelectorAll(".dir-link").forEach(n=>{n.onclick=o=>{o.preventDefault(),e.onNavigate(n.getAttribute("href"))}}),w.tbody.querySelectorAll(".action-enter").forEach(n=>{n.onclick=()=>e.onNavigate(n.getAttribute("data-href"))}),w.tbody.querySelectorAll(".action-view").forEach(n=>{n.onclick=()=>e.onView(n.getAttribute("data-href"),n.getAttribute("data-name"))}),w.tbody.querySelectorAll(".action-rename").forEach(n=>{n.onclick=()=>e.onRename(n.getAttribute("data-href"))}),w.tbody.querySelectorAll(".action-delete").forEach(n=>{n.onclick=()=>e.onDelete(n.getAttribute("data-href"))})}async function re(e){const t=e+(e.includes("?")?"&":"?")+"__list=1",n=await fetch(t,{method:"GET",credentials:"include"});if(!n.ok)throw new Error("JSON 列表失败，HTTP "+n.status);const o=await n.json();return(Array.isArray(o.items)?o.items:[]).map(r=>({name:String(r.name||"").replace(/\/$/,""),isDir:!!r.isDir,size:r.size==null?null:Number(r.size),mtime:r.mtime?new Date(r.mtime*1e3).toUTCString():null,href:F(e,String(r.name||""))}))}async function ie(e,t){const o=await fetch(e,{method:"PROPFIND",headers:{Depth:"1","Content-Type":"text/xml; charset=utf-8"},body:`<?xml version="1.0" encoding="utf-8"?>
<d:propfind xmlns:d="DAV:">
  <d:prop>
    <d:displayname/>
    <d:getcontentlength/>
    <d:getlastmodified/>
    <d:resourcetype/>
  </d:prop>
</d:propfind>`,credentials:"include"});if(!o.ok)throw new Error("PROPFIND 失败，HTTP "+o.status);const s=await o.text(),i=new DOMParser().parseFromString(s,"application/xml"),u=Array.from(i.getElementsByTagNameNS("*","response")),l=[];for(const a of u){const m=a.getElementsByTagNameNS("*","href")[0];if(!m)continue;const c=q(m.textContent||"",t);if(!c||ne(c,e))continue;const h=a.getElementsByTagNameNS("*","propstat")[0],p=h?h.getElementsByTagNameNS("*","prop")[0]:null,$=p&&p.getElementsByTagNameNS("*","displayname")[0]?.textContent||"",v=p&&p.getElementsByTagNameNS("*","getcontentlength")[0]?.textContent||"",E=p&&p.getElementsByTagNameNS("*","getlastmodified")[0]?.textContent||"",C=p?p.getElementsByTagNameNS("*","resourcetype")[0]:null,M=!!(C&&C.getElementsByTagNameNS("*","collection")[0]),Y=decodeURIComponent($||c.split("/").filter(Boolean).pop()||"");l.push({name:Y,isDir:M||c.endsWith("/"),size:M?null:v?Number(v):null,mtime:E||null,href:c})}return l.sort((a,m)=>a.isDir===m.isDir?a.name.localeCompare(m.name):a.isDir?-1:1)}async function ae(e){const t=await fetch(e,{method:"GET",credentials:"include"});if(!t.ok)throw new Error("目录获取失败，HTTP "+t.status);if(!(t.headers.get("Content-Type")||"").includes("text/html"))throw new Error("非 HTML 索引，无法解析");const o=await t.text(),s=new DOMParser().parseFromString(o,"text/html"),r=[],i=s.querySelector("table");if(i){const l=Array.from(i.querySelectorAll("tr"));for(let a=1;a<l.length;a++){const m=l[a].children;if(m.length<2)continue;const c=m[0].querySelector("a");if(!c)continue;const h=c.getAttribute("href")||"",p=(c.textContent||"").trim();if(!h||p===".."||h==="../")continue;const $=q(h.startsWith("http")?h:new URL(h,e).href,window.location.origin);if(!$.startsWith(e))continue;const v=decodeURIComponent($.split("/").filter(Boolean).pop()||""),E=m[1]?.textContent?.trim()||null,C=m[2]?.textContent?.trim()||null,M=h.endsWith("/")||p.endsWith("/");r.push({name:v,isDir:M,size:null,sizeRaw:C&&C!=="-"?C:null,mtime:null,mtimeRaw:E&&E!=="-"?E:null,href:$})}}else{const l=Array.from(s.querySelectorAll("a"));for(const a of l){const m=(a.textContent||"").trim(),c=a.getAttribute("href")||"";if(!c||m===".."||c==="../")continue;const h=q(c.startsWith("http")?c:new URL(c,e).href,window.location.origin);if(!h.startsWith(e))continue;const p=decodeURIComponent(h.split("/").filter(Boolean).pop()||"");r.push({name:p,isDir:h.endsWith("/"),size:null,sizeRaw:null,mtime:null,mtimeRaw:null,href:h})}}const u=new Map(r.map(l=>[l.href,l]));return Array.from(u.values()).sort((l,a)=>l.isDir===a.isDir?l.name.localeCompare(a.name):l.isDir?-1:1)}async function le(e){try{const n=((await fetch(e,{method:"OPTIONS",credentials:"include"})).headers.get("Allow")||"").toUpperCase();return{supportsPut:n.includes("PUT"),supportsMove:n.includes("MOVE"),supportsDelete:n.includes("DELETE")}}catch{return{supportsPut:!1,supportsMove:!1,supportsDelete:!1}}}const J=document.getElementById("viewer-overlay"),f=document.getElementById("viewer-pre"),b=document.getElementById("viewer-html"),_=document.getElementById("viewer-img-wrap"),ce=document.getElementById("viewer-img"),P=document.getElementById("viewer-video"),de=document.getElementById("viewer-title"),j=document.getElementById("viewer-hint"),ue=document.getElementById("viewer-open-raw"),L=document.getElementById("viewer-toggle"),me=document.getElementById("viewer-close"),D=document.getElementById("viewer-word-wrap");me.onclick=()=>J.classList.add("hidden");window.addEventListener("keydown",e=>{e.key==="Escape"&&J.classList.add("hidden")});let I=!1,z="",U={},S=new Set;function pe(e,t=""){const n=e.split(`
`),o={};if(t.toLowerCase().endsWith(".py"))for(let r=0;r<n.length;r++){const i=n[r];if(!i.trimEnd().endsWith(":"))continue;const l=i.length-i.trimStart().length;let a=r;for(let m=r+1;m<n.length;m++){const c=n[m];if(c.trim().length===0){a=m;continue}if(c.length-c.trimStart().length<=l)break;a=m}a>r&&(o[r]=a)}else{const r=[];for(let i=0;i<n.length;i++){const u=n[i];for(let l of u)if(l==="{")r.push(i);else if(l==="}"){const a=r.pop();a!==void 0&&i>a&&(o[a]||(o[a]=i))}}}return o}D.onclick=()=>{I=!I,D.classList.toggle("active",I),f.classList.toggle("wrap",I)};function k(e=!1){f.style.padding="0";let t="";if(e&&window.hljs)try{t=window.hljs.highlightAuto(z).value}catch{t=x(z)}else t=x(z);const n=t.split(`
`);let o="";for(let s=0;s<n.length;s++){const r=U[s]!==void 0,i=S.has(s),u=["ln-row",i?"folded":""].join(" ").trim(),l=r?`<span class="ln-fold" data-line="${s}"></span>`:"",a=`<span class="ln-num" data-num="${s+1}">${l}</span>`;let m=n[s]||" ";i&&(m+=`<span class="folded-ellipsis" data-line="${s}">...</span>`),o+=`<div class="${u}">${a}<span class="ln-content">${m}</span></div>`,i&&(s=U[s])}f.innerHTML=o,f.querySelectorAll("[data-line]").forEach(s=>{s.onclick=r=>{r.stopPropagation();const i=parseInt(s.dataset.line);S.has(i)?S.delete(i):S.add(i),k(e)}})}const W=512*1024;async function he(e,t){de.textContent=t,ue.setAttribute("href",e),f.textContent="加载中...",b.style.display="none",_.style.display="none",P.style.display="none",P.pause(),P.src="",f.style.display="block",L.classList.add("hidden"),j.textContent="",J.classList.remove("hidden");try{let n=null;try{const i=await fetch(e,{method:"HEAD",credentials:"include"});if(i.ok){const u=i.headers.get("Content-Length");u&&(n=Number(u))}}catch{}let o,s=!1;if(n!=null&&n>W?(o=await fetch(e,{method:"GET",headers:{Range:`bytes=0-${W-1}`},credentials:"include"}),s=!0):o=await fetch(e,{method:"GET",credentials:"include"}),!o.ok)throw new Error(`HTTP ${o.status}`);if(ee(t)){ce.src=e,_.style.display="block",f.style.display="none",D.classList.add("hidden");return}if(te(t)){P.src=e,P.style.display="block",f.style.display="none",D.classList.add("hidden"),j.textContent="提示：视频加载可能需要一些时间";return}D.classList.remove("hidden");const r=await o.text();if(z=r,S.clear(),U=pe(r,t),t.toLowerCase().endsWith(".md")){k(),await we(2e3);const i=!!(window.marked&&window.DOMPurify);try{const u=i?be(r):O(r);b.innerHTML=u,$e(b,e)}catch{b.innerHTML=O(r)}if(b.style.display="block",f.style.display="none",L.textContent="源码",L.classList.remove("hidden"),L.onclick=()=>{b.style.display!=="none"?(b.style.display="none",f.style.display="block",L.textContent="渲染",k()):(b.style.display="block",f.style.display="none",L.textContent="源码")},window.MathJax&&window.MathJax.typesetPromise)try{await window.MathJax.typesetPromise([b])}catch{}}else!t.toLowerCase().endsWith(".txt")&&!t.toLowerCase().endsWith(".log")?(await ge(2e3),k(!0)):k(!1);s&&(j.textContent=`仅预览前 ${Math.round(W/1024)}KB，点击“下载”查看完整内容。`)}catch(n){f.textContent=`加载失败：${n&&n.message?n.message:String(n)}`}}let A=null;function fe(){return A||(A=new Promise(async e=>{try{const t=[];if(window.hljs||t.push(N("https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js")),!document.querySelector('link[href*="highlight.js"]')){const n=document.createElement("link");n.rel="stylesheet",n.href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css",document.head.appendChild(n)}await Promise.all(t)}catch{}e()}),A)}function ge(e){return Promise.race([fe(),new Promise(t=>setTimeout(t,e))])}let H=null;function ye(){return H||(H=new Promise(async e=>{try{const t=[];window.marked||t.push(N("https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js")),window.DOMPurify||t.push(N("https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js")),window.MathJax||(window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},svg:{fontCache:"global"}},t.push(N("https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"))),await Promise.all(t)}catch{}e()}),H)}function we(e){return Promise.race([ye(),new Promise(t=>setTimeout(t,e))])}function N(e){return new Promise((t,n)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=()=>n(new Error("load failed: "+e)),document.head.appendChild(o)})}function be(e){try{const t={gfm:!0,breaks:!0,mangle:!1,headerIds:!0},n=window.marked.parse(e,t);return window.DOMPurify.sanitize(n,{USE_PROFILES:{html:!0}})}catch{return O(e)}}function $e(e,t){const n=new URL(t,window.location.origin);e.querySelectorAll("a[href]").forEach(o=>{const s=o.getAttribute("href")||"";if(!(/^(?:[a-z]+:)?\/\//i.test(s)||s.startsWith("#")||s.startsWith("/")))try{o.href=new URL(s,n).href}catch{}}),e.querySelectorAll("img[src]").forEach(o=>{const s=o.getAttribute("src")||"";if(!(/^(?:[a-z]+:)?\/\//i.test(s)||s.startsWith("/")))try{o.src=new URL(s,n).href}catch{}})}function O(e){let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return t=t.replace(/```([\s\S]*?)```/g,(o,s)=>`<pre><code>${s.replace(/\n$/,"")}</code></pre>`),t=t.replace(/^######\s+(.*)$/gm,"<h6>$1</h6>").replace(/^#####\s+(.*)$/gm,"<h5>$1</h5>").replace(/^####\s+(.*)$/gm,"<h4>$1</h4>").replace(/^###\s+(.*)$/gm,"<h3>$1</h3>").replace(/^##\s+(.*)$/gm,"<h2>$1</h2>").replace(/^#\s+(.*)$/gm,"<h1>$1</h1>"),t=t.replace(/^(\s*)([-*])\s+(.*)$/gm,"$1<li>$3</li>"),t=t.replace(/(?:^(?:<li>.*<\/li>)(?:\n|$))+?/gm,o=>`<ul>${o.replace(/\n/g,"")}</ul>`),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>'),t.split(/\n\n+/).map(o=>/^<h\d|^<pre|^<ul|^<li|^<blockquote/.test(o)?o:`<p>${o.replace(/\n/g,"<br/>")}</p>`).join(`
`)}const y={refreshBtn:document.getElementById("refresh-btn"),fileInput:document.getElementById("file-input"),dropzone:document.getElementById("upload-zone"),tbody:document.getElementById("file-tbody")};async function T(){g("正在加载列表..."),y.tbody.innerHTML='<tr><td colspan="4" class="muted">加载中...</td></tr>';try{let e=[];try{e=await re(d.basePath),d.webdavCapable=!1}catch{try{e=await ie(d.basePath,d.origin),d.webdavCapable=!0}catch{d.webdavCapable=!1,e=await ae(d.basePath)}}d.items=e;const t=await le(d.basePath);d.supportsPut=t.supportsPut,d.supportsMove=t.supportsMove,d.supportsDelete=t.supportsDelete,d.webdavCapable||await ve(d.items),se({onNavigate:R,onView:he,onRename:Ee,onDelete:Te}),g(`已加载 ${e.length} 项`)}catch(e){console.error(e),g(String(e&&e.message||e),"error"),y.tbody.innerHTML='<tr><td colspan="4" class="muted">加载失败</td></tr>'}}async function ve(e){const t=e.filter(n=>!n.isDir);await Promise.all(t.map(async n=>{try{const o=await fetch(n.href,{method:"HEAD",credentials:"include"});if(!o.ok)return;const s=o.headers.get("Content-Length"),r=o.headers.get("Last-Modified");s&&(n.size=Number(s)),r&&(n.mtime=r)}catch{}}))}function R(e){const t=new URL(e,d.origin),n=t.pathname.endsWith("/")?t.pathname:t.pathname+"/";d.currentPathname=n,d.basePath=n,history.pushState({path:n},"",n),V(R),T()}async function X(e){if(!e||!e.length)return;if(!d.supportsPut){g("服务端不支持上传（PUT）","error");return}const t=document.getElementById("upload-progress-container"),n=document.getElementById("upload-progress-bar"),o=document.getElementById("upload-filename"),s=document.getElementById("upload-speed"),r=document.getElementById("upload-size");t.classList.remove("hidden");for(const i of e){console.log("[Upload Debug] 准备上传文件:",{name:i.name,size:i.size,type:i.type,lastModified:i.lastModified});const u=F(d.basePath,i.name);o.textContent=i.name,n.style.width="0%",s.textContent="0 KB/s";const l=B(i.size);r.textContent=`0B / ${l}`,g(`正在准备上传：${i.name} (${l})`),i.size===0&&console.warn(`[Upload Warning] 文件 ${i.name} 大小为 0，可能导致上传异常。`),await new Promise((a,m)=>{const c=new XMLHttpRequest,h=Date.now();c.upload.onprogress=p=>{if(p.lengthComputable&&p.total>0){const $=Math.round(p.loaded/p.total*100);n.style.width=$+"%",r.textContent=`${B(p.loaded)} / ${B(p.total)}`;const v=(Date.now()-h)/1e3;if(v>0){const E=p.loaded/v;s.textContent=B(E)+"/s"}}},c.onload=()=>{console.log(`上传响应：${i.name} -> HTTP ${c.status}`),c.status>=200&&c.status<300?(g(`上传完成：${i.name}`,"success"),a()):m(new Error(`响应错误 HTTP ${c.status}`))},c.onerror=p=>{console.error("XHR 网络错误：",p),m(new Error("网络连接中断或被拒绝"))},c.open("PUT",K(u),!0),c.withCredentials=!0,c.setRequestHeader("Content-Type",i.type||"application/octet-stream"),c.setRequestHeader("Overwrite","T"),console.log(`开始上传：${i.name} -> ${u} (${B(i.size)})`),c.send(i)}).catch(a=>{console.error("上传异常详情：",a),g(`上传异常：${i.name}（${a.message}）`,"error")})}setTimeout(()=>{t.classList.add("hidden")},1500),await T()}function Ee(e){const t=decodeURIComponent(e.split("/").filter(Boolean).pop()||""),n=Array.from(y.tbody.querySelectorAll("button[data-href]")).find(l=>l.getAttribute("data-href")===e)?.closest("tr");if(!n)return;const o=n.children[0],s=e.endsWith("/"),r=document.createElement("div");r.className="inline-form",r.innerHTML=`
        <input type="text" value="${x(t)}" aria-label="新名称" style="flex:1" />
        <button class="btn ok-btn">确定</button>
        <button class="btn cancel-btn">取消</button>
    `;const i=o.innerHTML;o.innerHTML="",o.appendChild(r);const u=r.querySelector("input");r.querySelector(".cancel-btn").onclick=()=>{o.innerHTML=i},r.querySelector(".ok-btn").onclick=async()=>{const l=u.value.trim();if(!l||l===t){o.innerHTML=i;return}try{await xe(e,l,s),g("重命名成功","success"),await T()}catch(a){console.error(a),g("重命名失败："+a.message,"error"),o.innerHTML=i}},u.focus(),u.select()}async function xe(e,t,n){const o=F(d.basePath,t)+(n&&!t.endsWith("/")?"/":""),s=await fetch(e,{method:"MOVE",headers:{Destination:d.origin+K(o),Overwrite:"T"},credentials:"include"});if(!s.ok)throw new Error("HTTP "+s.status)}async function Te(e){const t=decodeURIComponent(e.split("/").filter(Boolean).pop()||e);if(confirm(`确认删除：${t} ？`))try{g("删除中...");const n=await fetch(e,{method:"DELETE",credentials:"include"});if(!n.ok)throw new Error("HTTP "+n.status);g("删除成功","success"),await T()}catch(n){console.error(n),g("删除失败："+n.message,"error")}}y.refreshBtn.onclick=T;y.fileInput.onchange=e=>X(e.target.files);y.dropzone.ondragover=e=>{e.preventDefault(),y.dropzone.classList.add("dragover")};y.dropzone.ondragleave=()=>y.dropzone.classList.remove("dragover");y.dropzone.ondrop=e=>{e.preventDefault(),y.dropzone.classList.remove("dragover"),X(e.dataTransfer?.files)};window.onpopstate=()=>{const e=G(location.pathname);d.currentPathname=e,d.basePath=e,V(R),T()};V(R);T();</script>
</head>

<body>
    <div class="container">
        <header>
            <h1>文件管理器</h1>
            <div class="path" id="current-path"></div>
        </header>

        <div class="toolbar">
            <button id="refresh-btn">刷新</button>
            <label class="btn" for="file-input">选择文件上传</label>
            <input id="file-input" type="file" multiple class="hidden" />
        </div>
        <div class="status" id="status"></div>
        <div id="upload-progress-container" class="hidden" style="margin: 12px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                <span id="upload-filename" class="sub"
                    style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">文件名</span>
                <div style="display: flex; gap: 12px; margin-left: 8px;">
                    <span id="upload-size" class="sub">0B / 0B</span>
                    <span id="upload-speed" class="sub">0 KB/s</span>
                </div>
            </div>
            <div
                style="height: 8px; background: #0f1527; border-radius: 4px; overflow: hidden; border: 1px solid #25304a;">
                <div id="upload-progress-bar"
                    style="width: 0%; height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); transition: width 0.3s;">
                </div>
            </div>
        </div>

        <div class="panel">
            <table class="table" id="file-table">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th class="nowrap">大小</th>
                        <th class="nowrap">修改时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="file-tbody">
                    <tr>
                        <td colspan="4" class="muted">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="viewer-overlay" class="hidden"
            style="position:fixed; inset:0; background:rgba(0,0,0,0.55); align-items:center; justify-content:center; z-index:9999;">
            <div
                style="background:var(--muted); border:1px solid #25304a; border-radius:12px; width:min(1000px, 92vw); height:min(80vh, 800px); display:flex; flex-direction:column; overflow:hidden;">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0f1527; border-bottom:1px solid #25304a;">
                    <div id="viewer-title" class="muted"
                        style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                    <div style="display:flex; gap:8px;">
                        <button id="viewer-toggle" class="btn hidden">源码</button>
                        <button id="viewer-word-wrap" class="btn" title="开启/关闭自动换行">换行</button>
                        <a id="viewer-open-raw" class="btn" target="_blank" rel="noopener" download>下载</a>
                        <button id="viewer-close" class="btn">关闭</button>
                    </div>
                </div>
                <div style="flex:1; overflow:auto; position:relative;">
                    <div id="viewer-img-wrap"><img id="viewer-img" alt="preview" /></div>
                    <video id="viewer-video" controls playsinline
                        style="display:none; width:100%; max-height:100%; background:#000;"></video>
                    <div id="viewer-html" class="md-body"
                        style="display:none; padding:14px; background:#0b1020; color:#e6edf3; line-height:1.6;"></div>
                    <pre id="viewer-pre"
                        style="margin:0; padding:0; background:#0b1020; color:#e6edf3; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre;">
                    </pre>
                </div>
                <div id="viewer-hint" class="hint" style="padding:8px 12px; border-top:1px solid #25304a;"></div>
            </div>
        </div>

        <div id="upload-zone" class="dropzone">
            拖拽文件到此处上传，或点击上方“选择文件上传”<br />
            <span class="hint">上传会使用 HTTP PUT 到当前目录；如需重名覆盖请确认服务端允许</span>
        </div>

        <p class="hint">说明：页面优先使用 WebDAV 方法（PROPFIND/PUT/MOVE/DELETE）。若服务端未启用 WebDAV，将尝试解析目录索引 HTML
            获取列表；但重命名/删除需服务端支持相应方法。</p>
    </div>
</body>

</html>