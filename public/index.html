<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Manager</title>
    <style>
        /* CSS样式 */
        #fileContent {
            margin-top: 20px;
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <h1>File Manager</h1>
        <div>
            <h2>文件列表</h2>
            <div>当前目录：<span id="currentDir"></span></div>
            <div>
                <input type="text" id="dirName" placeholder="New directory name">
                <button onclick="createDirectory()">Create Directory</button>
            </div>
            <div>
                <input type="file" id="fileInput">
                <button onclick="uploadFile()">Upload</button>
            </div>
            <div>
                <input type="text" id="oldFilename" placeholder="Old filename">
                <input type="text" id="newFilename" placeholder="New filename">
                <button onclick="renameFile()">Rename File</button>
            </div>
            <ul id="fileList"></ul>
        </div>            


    <h2>File Content</h2>
	<div id="openFilename"></div>
    <textarea id="fileContent" placeholder="File content will be displayed here..."></textarea>
    <button onclick="saveFile()">Save File</button>

    <script>
        let currentDir = '.'; // 当前目录

       // 获取文件列表
        async function fetchFileList(dir = currentDir) {
            document.getElementById('currentDir').innerText = dir+'/';
            const response = await fetch(`/api/files/${dir}`); 
            const files = await response.json();
            const fileList = document.getElementById('fileList'); 
            fileList.innerHTML = ''; 
            files.forEach(file => {
                const li = document.createElement('li'); 
                const span = document.createElement('span');
                span.innerText = file; 
                li.appendChild(span);
                li.onclick = () => viewFile(file); // 点击查看文件内容
                li.appendChild(createDeleteButton(file)); 
                li.appendChild(createDownloadButton(file)); // 添加下载按钮
                fileList.appendChild(li); 
            });
        }

        // 创建目录
        async function createDirectory() {
            const dirName = document.getElementById('dirName').value; 
            await fetch(`/api/create-dir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: dirName })
            });
            fetchFileList(currentDir); 
        }

        // 上传文件
        async function uploadFile() {
            const input = document.getElementById('fileInput');
            const formData = new FormData();
            formData.append('file', input.files[0]);
            await fetch(`/api/upload/${currentDir}`, { 
                method: 'POST',
                body: formData
            });
            fetchFileList(currentDir); 
        }
/*
        // 重命名文件
        async function renameFile() {
            const oldName = document.getElementById('oldFilename').value;
            const newName = document.getElementById('newFilename').value;
            await fetch(`/api/rename-file/${currentDir}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ oldName, newName })
            });
            fetchFileList(currentDir);
        }
*/
        async function viewFile(filename) {
            const fullPath = `${currentDir}/${encodeURIComponent(filename)}`; // 生成完整路径
			document.getElementById('openFilename').innerText = filename; // 显示文件名称
            console.log(`Fetching file from: /api/view-file/${fullPath}`); // Log the full API endpoint for debugging
            const response = await fetch(`/api/view-file/${fullPath}`);
    
            if (response.ok) {
                const data = await response.text(); // 获取文件内容
                document.getElementById('fileContent').value = data; // 显示文件内容
            } else {
                alert('Error fetching file content: ' + response.statusText); // 提示错误
            }
        }

        // 保存文件内容
        async function saveFile() {
            const filename = document.getElementById('openFilename').innerText;
            const content = document.getElementById('fileContent').value; // 获取文本区域内容
            
            // 创建要保存的 Blob 对象
            const blob = new Blob([content], { type: 'text/plain' });
            const formData = new FormData();
            formData.append('file', blob, filename);
            
            await fetch(`/api/upload/${currentDir}`, {
                method: 'POST',
                body: formData
            });
            fetchFileList(currentDir); // 刷新文件列表
            alert('File saved successfully!'); // 显示保存成功的提示
        }

		// 删除文件
        function createDeleteButton(filename) {
            const button = document.createElement('button');
            button.textContent = '删除';
            button.onclick = async () => {
                await fetch(`/api/delete-file/${currentDir}/${filename}`, { method: 'DELETE' }); 
                fetchFileList(currentDir); 
            };
            return button; 
        }
		
		// 下载文件
        function createDownloadButton(filename) {
            const button = document.createElement('button');
            button.textContent = '下载';
            button.onclick = async () => {
                window.location.href = `/api/download/${currentDir}/${filename}`; // 下载文件
            };
            return button; 
        }
/*
		// 重命名
        function createRenameButton(filename) {
            const button = document.createElement('button');
            button.textContent = '重命名';
            button.onclick = async () => {
                window.location.href = `/api/download/${currentDir}/${filename}`; // 下载文件
            };
            return button; 
            const oldName = document.getElementById('oldFilename').value;
            const newName = document.getElementById('newFilename').value;
            await fetch(`/api/rename-file/${currentDir}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ oldName, newName })
            });
            fetchFileList(currentDir);
        }
*/
        fetchFileList(); 
    </script>
</body>
</html>
